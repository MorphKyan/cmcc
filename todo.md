# 代码审查待办事项

## 🔴 严重问题

### 1. 修复火山引擎LLM处理器缺少异步支持的问题
- `ark_llm_handler.py` 使用同步的 `get_response` 方法
- 在异步WebSocket管道中会阻塞事件循环，严重影响性能
- **解决方案**: 重写为异步版本，使用 `httpx.AsyncClient` 或火山引擎的异步SDK

### 2. 修复音频解码器潜在的内存问题
- `stream_decoder.py` 中每次解码都拼接header_chunk，可能导致内存累积
- WebM流解码逻辑不完整，缺少对流式音频的正确处理
- **解决方案**: 重构解码逻辑，正确处理流式音频的连续性

### 3. 修复VAD处理器历史缓冲区管理问题
- `vad_processor.py` 中历史缓冲区大小维护被注释掉
- 长时间运行可能导致内存无限增长
- **解决方案**: 启用缓冲区大小限制逻辑

## 🟡 中等问题

### 4. 统一错误处理策略
- 部分模块使用 `logger.exception()` 但不向上抛出异常
- RAG处理器初始化失败时直接 `exit(1)`，过于激进
- **解决方案**: 统一错误处理策略，使用异常链传递错误信息

### 5. 重构配置管理，移除硬编码的API密钥
- API密钥硬编码在 `config.py` 中
- 火山引擎配置与Ollama配置分离，不够统一
- **解决方案**: 使用环境变量或配置文件管理敏感信息

### 6. 增加输入验证和安全检查
- WebSocket音频数据缺少格式验证
- CSV文件上传验证不够严格
- **解决方案**: 增加更多输入验证和安全检查

## 🟢 优化建议

### 7. 实现ASR处理器批量处理优化
- ASR处理器可以批量处理音频片段
- 考虑使用连接池管理HTTP客户端
- **解决方案**: 实现批量处理和连接复用

### 8. 重构LLM处理器输出映射逻辑
- LLM处理器的输出映射逻辑可以提取为独立模块
- 配置类可以进一步模块化
- **解决方案**: 重构为更清晰的分层架构

### 9. 添加性能监控和详细日志
- 缺少关键性能指标监控
- 日志级别不够细致
- **解决方案**: 添加性能监控和更详细的日志记录

### 10. 为关键模块添加单元测试和集成测试
- 缺少单元测试和集成测试
- **解决方案**: 为关键模块添加测试用例

https http混合连接问题
可以自定义配置后端地址和端口
vad core重启
llm监控
请分析llm的function calling 和 validation是否应该重构得更统一